
// ==UserScript==
// @name        Twitch Stream Saver 2
// @namespace   samlinz
// @match       https://www.twitch.tv/*
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_registerMenuCommand
// @icon https://static.twitchcdn.net/assets/favicon-32-d6025c14e900565d6177.png
// @version     3
// @author      samlinz
// @description 9/21/2020, 1:20:46 PM
// ==/UserScript==

(()=>{var N=()=>{let e=1,n=10*1e3,o=10*1e3,r=30,a=!0,i="STREAM_SAVER: ",t=`stored_values_ver_${e}`;return{MAJOR_VER:e,INTERVAL_MATCH_URL:o,DIALOG_DOM_ID:"stream-saver-dialog",STORAGE_KEY:t,INTERVAL_UPDATE_TIME:n,LOGGING:a,LOG_PREFIX:i,MAX_AGE_DAYS:r}};var G=()=>({getTimedUrl:(n,o,r,a)=>`https://www.twitch.tv/videos/${n}?t=${o}h${r}m${a}s`}),_=e=>{let n=5*60*1e3,o,r;function a(){if(Date.now()<r+n)return o;let i=e();return r=Date.now(),o=i,o}return a},O=({constants:e})=>{let{LOGGING:n,LOG_PREFIX:o}=e;function r(...t){!n||console.error(o,...t)}function a(...t){!n||console.log(o,...t)}function i(...t){!n||console.warn(o,...t)}return{error:r,log:a,warn:i}},L=({constants:e})=>({set:(a,i)=>window.setTimeout(a,i),setInterval:(a,i)=>window.setInterval(a,i),remove:a=>clearTimeout(a)});var U=({logger:e})=>{function n(i){let t=i.pathname.split("/");return t[t.length-1]}function o(i){let t=i.querySelector(".vod-seekbar-time-labels [data-a-target='player-seekbar-current-time']");return!t||!t.textContent?null:t.textContent.split(":").map(m=>Number(m))}function r(i){let t=i.querySelector("[data-a-target='player-info-title'] > a");if(!t){let m=i.title.split("-");return m.length<2?null:m[0].trim()}return t.textContent}function a(i){let t=i.querySelector(".stream-info-card [data-test-selector='stream-info-card-component__subtitle']");return t?t.textContent:(t=i.querySelector("[data-a-target='stream-title']"),!t||!t.textContent?null:t.textContent.split("\u2022")[0])}return{getVideoId:n,getTime:o,getVideoName:a,getChannel:r}};var V=({constants:e,logger:n,getValue:o,setValue:r})=>{let{STORAGE_KEY:a,MAX_AGE_DAYS:i}=e,t={},m=()=>o(a,t),S=u=>m()[u],y=()=>Object.entries(m()),E=(u,f)=>{let c=m();if(!c)throw Error("Null storage");c[u]=f,r(a,c)},C=u=>{let f=m(),{[u]:c,...d}=f;return r(a,d),!!c};return{set:E,get:S,getAll:y,delete:C,clear:()=>r(a,{}),purge:()=>{for(let[u,{timestamp:f}]of y()){if(!f){n?.error(`Invalid timestamp for ${u}`);continue}let c=Date.now()-f,d=i*24*60*60*1e3;c>d&&C(u)&&n?.log(`Removed old stored value ${u}`)}}}};var M=({constants:e,storage:n,logger:o,parser:r,urlTool:a,timeouts:i})=>{let{DIALOG_DOM_ID:t}=e,m,S=()=>{let l=document.createElement("div");l.id=t,Object.assign(l.style,{width:"100%",height:"100vh",backgroundColor:"rgba(0, 0, 0, 0.5)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e4,display:"flex",justifyContent:"center"}),l.addEventListener("click",()=>{l.style.display="none"});let T=document.createElement("div");Object.assign(T.style,{height:"100%",width:"75%",display:"flex",flexDirection:"column",justifyContent:"center"}),l.appendChild(T);let u=document.createElement("div");Object.assign(u.style,{width:"100%",maxHeight:"50%",overflowY:"auto",backgroundColor:"aliceblue",tableLayout:"fixed",color:"black",padding:"5px",borderRadius:"5px",fontSize:"1.1em"}),T.appendChild(u);let f=document.createElement("table");f.addEventListener("click",g=>{g.stopPropagation()}),Object.assign(f.style,{width:"100%",height:"100%",tableLayout:"fixed"});let c=document.createElement("thead");c.style.borderBottom="1px solid";let d=document.createElement("tbody");f.appendChild(c),f.appendChild(d);function p(g){let h=document.createElement("th");return h.textContent=g,h}c.appendChild(p("Streamer")),c.appendChild(p("Name")),c.appendChild(p("Timestamp")),c.appendChild(p("Stored")),c.appendChild(p("URL")),c.appendChild(p("Actions"));let b=n.getAll();b.sort((g,h)=>h[1].timestamp-g[1].timestamp);for(let[g,{humanTime:h,value:w,videoName:v,channelName:D,url:x}]of b){let I=document.createElement("tr"),s=document.createElement("td");s.textContent=D||"-",Object.assign(s.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),s.title=D||"-",I.appendChild(s),s=document.createElement("td"),s.textContent=v||"-",Object.assign(s.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),s.title=v||"-",I.appendChild(s),s=document.createElement("td"),s.style.textAlign="center",s.textContent=w.join(":"),I.appendChild(s),s=document.createElement("td"),s.textContent=h||"-",Object.assign(s.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),s.title=h||"-",I.appendChild(s),s=document.createElement("td");let A=document.createElement("a");A.href=x||"-",A.textContent=x||"-",Object.assign(s.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),s.title=x||"-",s.appendChild(A),I.appendChild(s),s=document.createElement("td"),s.style.textAlign="right";let R=document.createElement("button");R.addEventListener("click",()=>{n.delete(g),I.style.display="none",o?.log(`Removed stored valued ${g}`)}),R.textContent="DELETE",s.appendChild(R),I.appendChild(s),d.appendChild(I)}u.appendChild(f),document.body.appendChild(l)},y=()=>{E();let l=document.createElement("div");l.id=t,l.style.cssText="background: black; z-index: 1000;";let T=document.createElement("dl");function u(g,h){let w=document.createElement("dt"),v=document.createElement("dd");return w.textContent=g,v.textContent=h,v.style.marginLeft="2em",v.style.fontWeight="bolder",[w,v]}let{value:f}=n.get("LAST_STORED")||{},c=r.getVideoId(location),d=r.getTime(document),p={VIDEO_ID:c,STREAMER:r.getChannel(document),TIME:d,STREAM_NAME:r.getVideoName(document),URL:d?a.getTimedUrl(c,d[0],d[1],d[2]):null,LAST_STORED:f};Object.entries(p).map(([g,h])=>u(g,h)).flat().forEach(g=>T.appendChild(g)),l.appendChild(T),document.body.appendChild(l),o?.log("Showing debug dialog"),m=i.set(y,1e3)};function E(){let l=document.getElementById(t);return l&&l.parentElement?(l.parentElement.removeChild(l),!0):!1}function C(){i.remove(m)}return{removeDialogIfPresent:E,createDialog:S,createDebug:y,clearDebugTimeout:C}},P=({logger:e,registerMenu:n,ui:o,storage:r})=>{n("Dialog",()=>{o.removeDialogIfPresent(),o.createDialog()}),n("Debug",()=>{if(o.clearDebugTimeout(),o.removeDialogIfPresent()){e?.log("Closing debug dialog");return}o.createDebug()}),n("Dump stored values",()=>{let a=r.getAll();a.sort((i,t)=>t[1].timestamp-i[1].timestamp),e?.log(`
${JSON.stringify(a,null,2)}`)}),n("Nuke DB",()=>{r.clear(),e?.log("Removed all entries")}),e?.log("Registered UI")};var k=({logger:e,parser:n,urlTool:o,storage:r,document:a,cache:i,constants:t,timeouts:m})=>{let{INTERVAL_UPDATE_TIME:S}=t,y=1;function E({fnGetTime:l,fnGetStreamName:T,fnGetStreamerName:u,fnSetStored:f,fnGetTimedVodUrl:c,id:d}){try{e?.log(`Running ${y++}`);let p=T(),b=u();if(!p||!b)return e?.warn("Could not fetch VOD information");let g=l();if(!g)return e?.warn("Could not fetch time information");let[h,w,v]=g;if(h===0&&w<1)return e?.log("Not storing anything yet");let D=Date.now();f(d,{timestamp:D,humanTime:new Date(D).toISOString(),value:g,videoName:p,channelName:b,url:c(d,h,w,v)});let x=g.join(":");e?.log(`Saved ${x} for ${d}`),r.set("LAST_STORED",{timestamp:Date.now(),value:x})}catch(p){e?.error("Error running interval",p)}}function C(){e?.log("Starting update interval");let l=n.getVideoId(location);if(!l||isNaN(Number(l)))return e?.error("Could not get video ID");let T=()=>n.getTime(a),u=i(()=>{let p=n.getVideoName(a);return e?.log(`Got current stream name: '${p}'`),p}),f=_(()=>{let p=n.getChannel(a);return e?.log(`Got current streamer: '${p}'`),p}),c=E.bind(null,{fnGetStreamName:u,fnGetStreamerName:f,fnSetStored:r.set,fnGetTime:T,fnGetTimedVodUrl:o.getTimedUrl,id:l}),d=m.setInterval(c,S);return e?.log(`Starting interval ${d}`),{cancel:()=>{e?.log(`Cancelling interval ${d}`),m.remove(d)}}}return{start:C}};function $(){let e,n=N(),o=O({constants:n}),r={constants:n,logger:o},a=_,i=window.document,t=U(r),m=G(),S=V({...r,getValue:GM_getValue,setValue:GM_setValue}),y=L(r),E=k({...r,cache:a,document:i,parser:t,storage:S,urlTool:m,timeouts:y}),C=M({constants:n,parser:t,storage:S,timeouts:y,urlTool:m,logger:o});o?.log("Initializing");function l(){o?.log("Matching URL");let T=location.pathname;T.startsWith("/videos")?e||(o?.log(`Current pathname '${T}' matches Twitch video portal, starting tracking`),e=E.start()):e&&(e.cancel(),e=null)}S.purge(),l(),y.setInterval(l,n.INTERVAL_MATCH_URL),P({constants:n,logger:o,storage:S,registerMenu:GM_registerMenuCommand,ui:C})}window.addEventListener("load",()=>{$()});})();
