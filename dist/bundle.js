
// ==UserScript==
// @name        Video Saver
// @namespace   samlinz
// @match       https://www.twitch.tv/*
// @match       https://www.youtube.com/*
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_registerMenuCommand
// @icon https://static.twitchcdn.net/assets/favicon-32-d6025c14e900565d6177.png
// @version     104
// @author      samlinz
// @description 9/21/2020, 1:20:46 PM
// ==/UserScript==

(()=>{var _=t=>(e,n)=>{let o=e[t],i=n[t];return o===i?0:o>i?1:-1};var L=()=>{let t=1,e=10*1e3,n=10*1e3,o=30,i=!0,s="STREAM_SAVER: ",a=`stored_values_ver_${t}`;return{MAJOR_VER:t,INTERVAL_MATCH_URL:n,DIALOG_DOM_ID:"stream-saver-dialog",STORAGE_KEY:a,INTERVAL_UPDATE_TIME:e,LOGGING:i,LOG_PREFIX:s,MAX_AGE_DAYS:o,DEBUG:!1}};var V=t=>{let e=5*60*1e3,n,o;function i(){if(Date.now()<o+e)return n;let s=t();return o=Date.now(),n=s,n}return i},M=({constants:t})=>{let{LOGGING:e,LOG_PREFIX:n}=t;function o(...a){!e||console.error(n,...a)}function i(...a){!e||console.log(n,...a)}function s(...a){!e||console.warn(n,...a)}return{error:o,log:i,warn:s}},O=({constants:t})=>({set:(i,s)=>window.setTimeout(i,s),setInterval:(i,s)=>window.setInterval(i,s),remove:i=>clearTimeout(i)});var G=({logger:t,parser:e,urlTool:n,storage:o,document:i,cache:s,constants:a,timeouts:r})=>{let{INTERVAL_UPDATE_TIME:d}=a,T=1;function w({fnGetTime:f,fnGetStreamName:g,fnGetStreamerName:y,fnSetStored:h,fnGetTimedVodUrl:b,options:p,id:u}){try{t?.log(`Running ${T++}`);let m=g(),S=y();if(!m||!S)return t?.error("Could not fetch VOD information",{streamName:m,streamerName:S});let E=f();if(!E)return t?.warn("Could not fetch time information");t?.log("Got time",E);let[C,I,x]=E;if(p.skipStartOfVideo&&C===0&&I<1)return t?.log("Not storing anything yet");let l=Date.now(),D=b(u,[C,I,x]);h(u,{timestamp:l,humanTime:new Date(l).toISOString(),value:E,videoName:m,channelName:S,url:D});let A=E.join(":");t?.log(`Saved ${A} for ${u}`),a.DEBUG&&t?.log({streamName:m,streamerName:S,time:E,hours:C,minutes:I,seconds:x,timestamp:l,vodUrl:D,storedTimeStr:A}),o.set("LAST_STORED",{timestamp:Date.now(),value:A})}catch(m){t?.error("Error running interval",m)}}let v=({skipStartOfVideo:f=!1}={})=>{let g=e.getVideoId(location);if(!g)return t?.error("Could not get video ID");t?.log(`Got video ID: '${g}'`);let y=()=>e.getTime(i),h=s(()=>{let u=e.getVideoName(i);return t?.log(`Got current stream name: '${u}'`),u}),b=V(()=>{let u=e.getChannel(i);return t?.log(`Got current streamer: '${u}'`),u});return w.bind(null,{fnGetStreamName:h,fnGetStreamerName:b,fnSetStored:o.set,fnGetTime:y,fnGetTimedVodUrl:n.getTimedUrl,id:g,options:{skipStartOfVideo:f}})};function c(){t?.log("Starting update interval");let f=v({skipStartOfVideo:!0}),g=r.setInterval(f,d);return t?.log(`Starting interval ${g}`),{cancel:()=>{t?.log(`Cancelling interval ${g}`),r.remove(g)}}}return{start:c,getRunInterval:v}};var N=({constants:t,logger:e,getValue:n,setValue:o,variant:i})=>{let{STORAGE_KEY:s,MAX_AGE_DAYS:a}=t,r=`${s}_${i}`,d={},T=()=>n(r,d),w=p=>T()[p],v=()=>Object.entries(T()),c=(p,u)=>{let m=T();if(!m)throw Error("Null storage");m[p]=u,o(r,m)},f=p=>{let u=T(),{[p]:m,...S}=u;return o(r,S),!!m};return{set:c,get:w,getAll:v,delete:f,clear:()=>o(r,{}),purge:()=>{for(let[p,{timestamp:u}]of v()){if(!u){e?.error(`Invalid timestamp for ${p}`);continue}let m=Date.now()-u,S=a*24*60*60*1e3;m>S&&f(p)&&e?.log(`Removed old stored value ${p}`)}},import:p=>{if(!p)throw Error("Null storage");o(r,p)},export:()=>n(r,d)}};function R(t){let e=document.createElement("th");return e.textContent=t,e}var U=({constants:t,storage:e,logger:n,parser:o,urlTool:i,timeouts:s})=>{let{DIALOG_DOM_ID:a}=t,r,d=()=>{try{n?.log("Showing dialog");let c=document.createElement("div");c.id=a,Object.assign(c.style,{width:"100%",height:"100vh",backgroundColor:"rgba(0, 0, 0, 0.5)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e4,display:"flex",justifyContent:"center"}),c.addEventListener("click",()=>{c.style.display="none"});let f=document.createElement("div");Object.assign(f.style,{height:"100%",width:"75%",display:"flex",flexDirection:"column",justifyContent:"center"}),c.appendChild(f);let g=document.createElement("div");Object.assign(g.style,{width:"100%",maxHeight:"50%",overflowY:"auto",backgroundColor:"aliceblue",tableLayout:"fixed",color:"black",padding:"5px",borderRadius:"5px",fontSize:"1.1em"}),f.appendChild(g);let y=document.createElement("table");y.addEventListener("click",u=>{u.stopPropagation()}),Object.assign(y.style,{width:"100%",height:"100%",tableLayout:"fixed"});let h=document.createElement("thead");h.style.borderBottom="1px solid";let b=document.createElement("tbody");y.appendChild(h),y.appendChild(b),h.appendChild(R("Streamer")),h.appendChild(R("Name")),h.appendChild(R("Timestamp")),h.appendChild(R("Stored")),h.appendChild(R("URL")),h.appendChild(R("Actions"));let p=e.getAll();p.sort((u,m)=>m[1].timestamp-u[1].timestamp);for(let[u,{humanTime:m,value:S,videoName:E,channelName:C,url:I}]of p){if(u==="LAST_STORED")continue;let x=document.createElement("tr"),l=document.createElement("td");l.textContent=C||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=C||"-",x.appendChild(l),l=document.createElement("td"),l.textContent=E||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=E||"-",x.appendChild(l),l=document.createElement("td"),l.style.textAlign="center",l.textContent=S.join(":"),x.appendChild(l),l=document.createElement("td"),l.textContent=m||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=m||"-",x.appendChild(l),l=document.createElement("td");let D=document.createElement("a");D.href=I||"-",D.textContent=I||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=I||"-",l.appendChild(D),x.appendChild(l),l=document.createElement("td"),l.style.textAlign="right";let A=document.createElement("button");A.addEventListener("click",()=>{e.delete(u),x.style.display="none",n?.log(`Removed stored valued ${u}`)}),A.textContent="DELETE",l.appendChild(A),x.appendChild(l),b.appendChild(x)}g.appendChild(y),document.body.appendChild(c)}catch(c){n?.error("Error while creating dialog",c)}},T=()=>{w();let c=document.createElement("div");c.id=a,c.style.cssText="background: black; color: white; z-index: 9999; position: absolute; top: 0; left: 0;";let f=document.createElement("dl");function g(m,S){let E=document.createElement("dt"),C=document.createElement("dd");return E.textContent=m,C.textContent=S,C.style.marginLeft="2em",C.style.fontWeight="bolder",[E,C]}let{value:y}=e.get("LAST_STORED")||{},h=o.getVideoId(location),b=o.getTime(document),p={VIDEO_ID:h,STREAMER:o.getChannel(document),TIME:b,STREAM_NAME:o.getVideoName(document),URL:b&&h?i.getTimedUrl(h,b):null,LAST_STORED:y};Object.entries(p).map(([m,S])=>g(m,S)).flat().forEach(m=>f.appendChild(m)),c.appendChild(f),document.body.appendChild(c),n?.log("Showing debug dialog"),r=s.set(T,1e3)};function w(){let c=document.getElementById(a);return c&&c.parentElement?(c.parentElement.removeChild(c),!0):!1}function v(){s.remove(r)}return{removeDialogIfPresent:w,createDialog:d,createDebug:T,clearDebugTimeout:v}},P=({logger:t,storage:e,ui:n})=>{let o=[];return o.push({title:"Dialog",fnAction:()=>{n.clearDebugTimeout(),n.removeDialogIfPresent(),n.createDialog()}}),o.push({title:"Debug",fnAction:()=>{if(n.clearDebugTimeout(),n.removeDialogIfPresent()){t?.log("Closing debug dialog");return}n.createDebug()}}),o.push({title:"Dump stored values",fnAction:()=>{let i=e.getAll();i.sort((s,a)=>a[1].timestamp-s[1].timestamp),t?.log(`
${JSON.stringify(i,null,2)}`)}}),o.push({title:"Nuke DB",fnAction:()=>{e.clear(),t?.log("Removed all entries")}}),o.push({title:"Export DB",fnAction:()=>{let i=e.export();t?.log({export:i})}}),o.push({title:"Import DB",fnAction:()=>{let i=window.prompt("Add db dump");if(!i)return;let s=JSON.parse(i);e.import(s),t?.log("Imported DB")}}),o},$=({logger:t,registerMenu:e,actions:n})=>{n.forEach(o=>{e(o.title,o.fnAction)}),t?.log("Registered UI")};var Y=()=>({getTimedUrl:(e,n)=>{let[o,i,s]=n;return`https://www.twitch.tv/videos/${e}?t=${o}h${i}m${s}s`}}),K=({logger:t})=>{function e(a){let r=a.pathname.split("/");return r[r.length-1]}let n=()=>{let a=document.querySelector("script[type='application/ld+json']")?.textContent;return a&&JSON.parse(a)[0]||null};function o(a){let r=a.querySelector(".vod-seekbar-time-labels [data-a-target='player-seekbar-current-time']");return!r||!r.textContent?null:r.textContent.split(":").map(d=>Number(d))}function i(a){let r=a.querySelector("[aria-label~='Viewers']");if(!r){let d=a.title.split("-");return d.length<2?null:d[0].trim()}return r.getAttribute("aria-label")?.split(" ")[0]}function s(a){let r=a.querySelector(".stream-info-card [data-test-selector='stream-info-card-component__subtitle']");return r?r.textContent:(r=a.querySelector("[data-a-target='stream-title']"),!r||!r.textContent?null:r.textContent.split("\u2022")[0])}return{getVideoId:e,getTime:o,getVideoName:s,getChannel:i}},k=()=>{let t,e=L(),n=M({constants:e}),o={constants:e,logger:n},i=V,s=window.document,a=K(o),r=Y(),d=N({...o,getValue:GM_getValue,setValue:GM_setValue,variant:"twitch"}),T=O(o),w=G({...o,cache:i,document:s,parser:a,storage:d,urlTool:r,timeouts:T}),v=U({constants:e,parser:a,storage:d,timeouts:T,urlTool:r,logger:n});n?.log("Initializing Twitch"),n?.log("Constants",{...e});function c(){n?.log("Matching URL");let g=location.pathname;g.startsWith("/videos")?t||(n?.log(`Current pathname '${g}' matches Twitch video portal, starting tracking`),t=w.start()):t&&(t.cancel(),t=null)}let f=[...P({logger:n,storage:d,ui:v})].sort(_("title"));return{init(){d.purge(),c(),T.setInterval(c,e.INTERVAL_MATCH_URL),$({constants:e,logger:n,registerMenu:GM_registerMenuCommand,actions:f})}}};var q=()=>({getTimedUrl:(e,n)=>{let[o,i,s]=n,a=(o||0)*3600+(i||0)*60+s;return`https://youtu.be/${e}?t=${a}`}}),z=({logger:t})=>{function e(s){return new URL(s.href).searchParams.get("v")}function n(s){let r=s.querySelector(".ytp-time-current")?.textContent?.split(":").map(d=>Number(d))||null;return r?r?.length<3?[0,r[0],r[1]]:[r[0],r[1],r[2]]:null}function o(s){return s.querySelector("[itemprop=author]")?.querySelector("[itemprop=name]")?.getAttribute("content")||null}function i(s){return s.title.split("- YouTube")[0].trim()}return{getVideoId:e,getTime:n,getVideoName:i,getChannel:o}},j=()=>{let t=L(),e=M({constants:t}),n={constants:t,logger:e},o=V,i=window.document,s=z(n),a=q(),r=N({...n,getValue:GM_getValue,setValue:GM_setValue,variant:"youtube"}),d=O(n),T=G({...n,cache:o,document:i,parser:s,storage:r,urlTool:a,timeouts:d}),w=U({constants:t,parser:s,storage:r,timeouts:d,urlTool:a,logger:e});e?.log("Initializing Youtube"),e?.log("Constants",{...t});let v=null,c=[...P({logger:e,storage:r,ui:w}),{title:"Start interval",fnAction:()=>{e.log("Starting interval manually"),v?.cancel(),v=T.start()}},{title:"Stop interval",fnAction:()=>{e.log("Stopping interval manually"),v?.cancel()}},{title:"Store timestamp",fnAction:()=>{e.log("Running interval manually"),T.getRunInterval({skipStartOfVideo:!1})?.()}}].sort(_("title"));return{init(){r.purge(),$({constants:t,logger:e,registerMenu:GM_registerMenuCommand,actions:c})}}};function B(){let t=location.host;if(t.includes("twitch"))k().init();else if(t.includes("youtube"))j().init();else throw Error(`${t} didn't match any known portal`)}window.addEventListener("load",()=>{B()});})();
