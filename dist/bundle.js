
// ==UserScript==
// @name        Video Saver
// @namespace   samlinz
// @match       https://www.twitch.tv/*
// @match       https://www.youtube.com/*
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_registerMenuCommand
// @icon https://static.twitchcdn.net/assets/favicon-32-d6025c14e900565d6177.png
// @version     105
// @author      samlinz
// @description 9/21/2020, 1:20:46 PM
// ==/UserScript==

(()=>{var R=t=>(e,n)=>{let o=e[t],a=n[t];return o===a?0:o>a?1:-1};var _=()=>{let t=1,e=10*1e3,n=10*1e3,o=30,a=!0,s="STREAM_SAVER: ",i=`stored_values_ver_${t}`;return{MAJOR_VER:t,INTERVAL_MATCH_URL:n,DIALOG_DOM_ID:"stream-saver-dialog",STORAGE_KEY:i,INTERVAL_UPDATE_TIME:e,LOGGING:a,LOG_PREFIX:s,MAX_AGE_DAYS:o,DEBUG:!1}};var O=({logger:t})=>e=>{let n=5*60*1e3,o,a;function s(){if(Date.now()<a+n)return o;let i=e();return i!=null?(a=Date.now(),o=i,o):(t?.warn("Will not cache nil value"),o)}return s},L=({constants:t})=>{let{LOGGING:e,LOG_PREFIX:n}=t;function o(...i){!e||console.error(n,...i)}function a(...i){!e||console.log(n,...i)}function s(...i){!e||console.warn(n,...i)}return{error:o,log:a,warn:s}},N=({constants:t})=>({set:(a,s)=>window.setTimeout(a,s),setInterval:(a,s)=>window.setInterval(a,s),remove:a=>clearTimeout(a)});var M=({logger:t,parser:e,urlTool:n,storage:o,document:a,cache:s,constants:i,timeouts:r})=>{let{INTERVAL_UPDATE_TIME:d}=i,p=1;function b({fnGetTime:h,fnGetStreamName:f,fnGetStreamerName:y,fnSetStored:T,fnGetTimedVodUrl:C,options:g,id:u}){try{t?.log(`Running ${p++}`);let m=f()||`Unknown ${u}`,S=y()||"UKNOWN";if(!m||!S)return t?.error("Could not fetch VOD information",{streamName:m,streamerName:S});let E=h();if(!E)return t?.warn("Could not fetch time information");t?.log("Got time",E);let[w,A,x]=E;if(g.skipStartOfVideo&&w===0&&A<1)return t?.log("Not storing anything yet");let l=Date.now(),D=C(u,[w,A,x]);T(u,{timestamp:l,humanTime:new Date(l).toISOString(),value:E,videoName:m,channelName:S,url:D});let I=E.join(":");t?.log(`Saved ${I} for ${u}`),i.DEBUG&&t?.log({streamName:m,streamerName:S,time:E,hours:w,minutes:A,seconds:x,timestamp:l,vodUrl:D,storedTimeStr:I}),o.set("LAST_STORED",{timestamp:Date.now(),value:I})}catch(m){t?.error("Error running interval",m)}}let v=({skipStartOfVideo:h=!1}={})=>{let f=e.getVideoId(location);if(!f)return t?.error("Could not get video ID");t?.log(`Got video ID: '${f}'`);let y=()=>e.getTime(a),T=s(()=>{let u=e.getVideoName(a);return t?.log(`Got current stream name: '${u}'`),u}),C=s(()=>{let u=e.getChannel(a);return t?.log(`Got current streamer: '${u}'`),u});return b.bind(null,{fnGetStreamName:T,fnGetStreamerName:C,fnSetStored:o.set,fnGetTime:y,fnGetTimedVodUrl:n.getTimedUrl,id:f,options:{skipStartOfVideo:h}})};function c(){t?.log("Starting update interval");let h=v({skipStartOfVideo:!0}),f=r.setInterval(h,d);return t?.log(`Starting interval ${f}`),{cancel:()=>{t?.log(`Cancelling interval ${f}`),r.remove(f)}}}return{start:c,getRunInterval:v}};var U=({constants:t,logger:e,getValue:n,setValue:o,variant:a})=>{let{STORAGE_KEY:s,MAX_AGE_DAYS:i}=t,r=`${s}_${a}`,d={},p=()=>n(r,d),b=g=>p()[g],v=()=>Object.entries(p()),c=(g,u)=>{let m=p();if(!m)throw Error("Null storage");m[g]=u,o(r,m)},h=g=>{let u=p(),{[g]:m,...S}=u;return o(r,S),!!m};return{set:c,get:b,getAll:v,delete:h,clear:()=>o(r,{}),purge:()=>{for(let[g,{timestamp:u}]of v()){if(!u){e?.error(`Invalid timestamp for ${g}`);continue}let m=Date.now()-u,S=i*24*60*60*1e3;m>S&&h(g)&&e?.log(`Removed old stored value ${g}`)}},import:g=>{if(!g)throw Error("Null storage");o(r,g)},export:()=>n(r,d)}};function V(t){let e=document.createElement("th");return e.textContent=t,e}var G=({constants:t,storage:e,logger:n,parser:o,urlTool:a,timeouts:s})=>{let{DIALOG_DOM_ID:i}=t,r,d=()=>{try{n?.log("Showing dialog");let c=document.createElement("div");c.id=i,Object.assign(c.style,{width:"100%",height:"100vh",backgroundColor:"rgba(0, 0, 0, 0.5)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e4,display:"flex",justifyContent:"center"}),c.addEventListener("click",()=>{c.style.display="none"});let h=document.createElement("div");Object.assign(h.style,{height:"100%",width:"75%",display:"flex",flexDirection:"column",justifyContent:"center"}),c.appendChild(h);let f=document.createElement("div");Object.assign(f.style,{width:"100%",maxHeight:"50%",overflowY:"auto",backgroundColor:"aliceblue",tableLayout:"fixed",color:"black",padding:"5px",borderRadius:"5px",fontSize:"1.1em"}),h.appendChild(f);let y=document.createElement("table");y.addEventListener("click",u=>{u.stopPropagation()}),Object.assign(y.style,{width:"100%",height:"100%",tableLayout:"fixed"});let T=document.createElement("thead");T.style.borderBottom="1px solid";let C=document.createElement("tbody");y.appendChild(T),y.appendChild(C),T.appendChild(V("Streamer")),T.appendChild(V("Name")),T.appendChild(V("Timestamp")),T.appendChild(V("Stored")),T.appendChild(V("URL")),T.appendChild(V("Actions"));let g=e.getAll();g.sort((u,m)=>m[1].timestamp-u[1].timestamp);for(let[u,{humanTime:m,value:S,videoName:E,channelName:w,url:A}]of g){if(u==="LAST_STORED")continue;let x=document.createElement("tr"),l=document.createElement("td");l.textContent=w||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=w||"-",x.appendChild(l),l=document.createElement("td"),l.textContent=E||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=E||"-",x.appendChild(l),l=document.createElement("td"),l.style.textAlign="center",l.textContent=S.join(":"),x.appendChild(l),l=document.createElement("td"),l.textContent=m||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=m||"-",x.appendChild(l),l=document.createElement("td");let D=document.createElement("a");D.href=A||"-",D.textContent=A||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=A||"-",l.appendChild(D),x.appendChild(l),l=document.createElement("td"),l.style.textAlign="right";let I=document.createElement("button");I.addEventListener("click",()=>{e.delete(u),x.style.display="none",n?.log(`Removed stored valued ${u}`)}),I.textContent="DELETE",l.appendChild(I),x.appendChild(l),C.appendChild(x)}f.appendChild(y),document.body.appendChild(c)}catch(c){n?.error("Error while creating dialog",c)}},p=()=>{b();let c=document.createElement("div");c.id=i,c.style.cssText="background: black; color: white; z-index: 9999; position: absolute; top: 0; left: 0;";let h=document.createElement("dl");function f(m,S){let E=document.createElement("dt"),w=document.createElement("dd");return E.textContent=m,w.textContent=S,w.style.marginLeft="2em",w.style.fontWeight="bolder",[E,w]}let{value:y}=e.get("LAST_STORED")||{},T=o.getVideoId(location),C=o.getTime(document),g={VIDEO_ID:T,STREAMER:o.getChannel(document),TIME:C,STREAM_NAME:o.getVideoName(document),URL:C&&T?a.getTimedUrl(T,C):null,LAST_STORED:y};Object.entries(g).map(([m,S])=>f(m,S)).flat().forEach(m=>h.appendChild(m)),c.appendChild(h),document.body.appendChild(c),n?.log("Showing debug dialog"),r=s.set(p,1e3)};function b(){let c=document.getElementById(i);return c&&c.parentElement?(c.parentElement.removeChild(c),!0):!1}function v(){s.remove(r)}return{removeDialogIfPresent:b,createDialog:d,createDebug:p,clearDebugTimeout:v}},P=({logger:t,storage:e,ui:n})=>{let o=[];return o.push({title:"Dialog",fnAction:()=>{n.clearDebugTimeout(),n.removeDialogIfPresent(),n.createDialog()}}),o.push({title:"Debug",fnAction:()=>{if(n.clearDebugTimeout(),n.removeDialogIfPresent()){t?.log("Closing debug dialog");return}n.createDebug()}}),o.push({title:"Dump stored values",fnAction:()=>{let a=e.getAll();a.sort((s,i)=>i[1].timestamp-s[1].timestamp),t?.log(`
${JSON.stringify(a,null,2)}`)}}),o.push({title:"Nuke DB",fnAction:()=>{e.clear(),t?.log("Removed all entries")}}),o.push({title:"Export DB",fnAction:()=>{let a=e.export();t?.log({export:a})}}),o.push({title:"Import DB",fnAction:()=>{let a=window.prompt("Add db dump");if(!a)return;let s=JSON.parse(a);e.import(s),t?.log("Imported DB")}}),o},$=({logger:t,registerMenu:e,actions:n})=>{n.forEach(o=>{e(o.title,o.fnAction)}),t?.log("Registered UI")};var Y=()=>({getTimedUrl:(e,n)=>{let[o,a,s]=n;return`https://www.twitch.tv/videos/${e}?t=${o}h${a}m${s}s`}}),q=({logger:t})=>{function e(i){let r=i.pathname.split("/");return r[r.length-1]}let n=()=>{let i=document.querySelector("script[type='application/ld+json']")?.textContent;return i&&JSON.parse(i)[0]||null};function o(i){let r=i.querySelector(".vod-seekbar-time-labels [data-a-target='player-seekbar-current-time']");return!r||!r.textContent?null:r.textContent.split(":").map(d=>Number(d))}function a(i){let r=i.querySelector("[aria-label~='Viewers']");if(!r){let d=i.title.split("-");return d.length<2?null:d[0].trim()}return r.getAttribute("aria-label")?.split(" ")[0]||null}function s(i){let r=i.querySelector(".stream-info-card [data-test-selector='stream-info-card-component__subtitle']");return r?r.textContent:(r=i.querySelector("[data-a-target='stream-title']"),!r||!r.textContent?null:r.textContent.split("\u2022")[0])}return{getVideoId:e,getTime:o,getVideoName:s,getChannel:a}},k=()=>{let t,e=_(),n=L({constants:e}),o={constants:e,logger:n},a=O,s=window.document,i=q(o),r=Y(),d=U({...o,getValue:GM_getValue,setValue:GM_setValue,variant:"twitch"}),p=N(o),b=M({...o,cache:a,document:s,parser:i,storage:d,urlTool:r,timeouts:p}),v=G({constants:e,parser:i,storage:d,timeouts:p,urlTool:r,logger:n});n?.log("Initializing Twitch"),n?.log("Constants",{...e});function c(){n?.log("Matching URL");let f=location.pathname;f.startsWith("/videos")?t||(n?.log(`Current pathname '${f}' matches Twitch video portal, starting tracking`),t=b.start()):t&&(t.cancel(),t=null)}let h=[...P({logger:n,storage:d,ui:v})].sort(R("title"));return{init(){d.purge(),c(),p.setInterval(c,e.INTERVAL_MATCH_URL),$({constants:e,logger:n,registerMenu:GM_registerMenuCommand,actions:h})}}};var K=()=>({getTimedUrl:(e,n)=>{let[o,a,s]=n,i=(o||0)*3600+(a||0)*60+s;return`https://youtu.be/${e}?t=${i}`}}),J=({logger:t})=>{function e(s){return new URL(s.href).searchParams.get("v")}function n(s){let r=s.querySelector(".ytp-time-current")?.textContent?.split(":").map(d=>Number(d))||null;return r?r?.length<3?[0,r[0],r[1]]:[r[0],r[1],r[2]]:null}function o(s){return[()=>{let p=s.querySelectorAll("[type='application/ld+json']")[0]?.textContent;return p&&JSON.parse(p).author||null},()=>s.querySelector("[itemprop=author]")?.querySelector("[itemprop=name]")?.getAttribute("content")||null,()=>s.querySelector("ytd-video-owner-renderer")?.querySelector(".yt-formatted-string")?.textContent||null].map(p=>{try{return p()}catch{return null}}).find(Boolean)||null}function a(s){return s.title.split("- YouTube")[0].trim()}return{getVideoId:e,getTime:n,getVideoName:a,getChannel:o}},j=()=>{let t=_(),e=L({constants:t}),n={constants:t,logger:e},o=O(n),a=window.document,s=J(n),i=K(),r=U({...n,getValue:GM_getValue,setValue:GM_setValue,variant:"youtube"}),d=N(n),p=M({...n,cache:o,document:a,parser:s,storage:r,urlTool:i,timeouts:d}),b=G({constants:t,parser:s,storage:r,timeouts:d,urlTool:i,logger:e});e?.log("Initializing Youtube"),e?.log("Constants",{...t});let v=null,c=[...P({logger:e,storage:r,ui:b}),{title:"Start interval",fnAction:()=>{e.log("Starting interval manually"),v?.cancel(),v=p.start()}},{title:"Stop interval",fnAction:()=>{e.log("Stopping interval manually"),v?.cancel()}},{title:"Store timestamp",fnAction:()=>{e.log("Running interval manually"),p.getRunInterval({skipStartOfVideo:!1})?.()}}].sort(R("title"));return{init(){r.purge(),$({constants:t,logger:e,registerMenu:GM_registerMenuCommand,actions:c})}}};function B(){let t=location.host;if(t.includes("twitch"))k().init();else if(t.includes("youtube"))j().init();else throw Error(`${t} didn't match any known portal`)}window.addEventListener("load",()=>{B()});})();
