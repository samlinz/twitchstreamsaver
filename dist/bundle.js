
// ==UserScript==
// @name        Video Saver
// @namespace   samlinz
// @match       https://www.twitch.tv/*
// @match       https://www.youtube.com/*
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_registerMenuCommand
// @icon https://static.twitchcdn.net/assets/favicon-32-d6025c14e900565d6177.png
// @version     59
// @author      samlinz
// @description 9/21/2020, 1:20:46 PM
// ==/UserScript==

(()=>{var _=e=>(t,n)=>{let o=t[e],a=n[e];return o===a?0:o>a?1:-1};var L=()=>{let e=1,t=10*1e3,n=10*1e3,o=30,a=!0,r="STREAM_SAVER: ",i=`stored_values_ver_${e}`;return{MAJOR_VER:e,INTERVAL_MATCH_URL:n,DIALOG_DOM_ID:"stream-saver-dialog",STORAGE_KEY:i,INTERVAL_UPDATE_TIME:t,LOGGING:a,LOG_PREFIX:r,MAX_AGE_DAYS:o,DEBUG:!1}};var k=()=>({getTimedUrl:(t,n)=>{let[o,a,r]=n,i=(o||0)*3600+(a||0)*60+r;return`https://youtu.be/${t}?t=${i}`}}),$=()=>({getTimedUrl:(t,n)=>{let[o,a,r]=n;return`https://www.twitch.tv/videos/${t}?t=${o}h${a}m${r}s`}}),R=e=>{let t=5*60*1e3,n,o;function a(){if(Date.now()<o+t)return n;let r=e();return o=Date.now(),n=r,n}return a},O=({constants:e})=>{let{LOGGING:t,LOG_PREFIX:n}=e;function o(...i){!t||console.error(n,...i)}function a(...i){!t||console.log(n,...i)}function r(...i){!t||console.warn(n,...i)}return{error:o,log:a,warn:r}},M=({constants:e})=>({set:(a,r)=>window.setTimeout(a,r),setInterval:(a,r)=>window.setInterval(a,r),remove:a=>clearTimeout(a)});var B=({logger:e})=>{function t(r){return new URL(r.href).searchParams.get("v")}function n(r){let s=r.querySelector(".ytp-time-current")?.textContent?.split(":").map(h=>Number(h))||null;return s?s?.length<3?[0,s[0],s[1]]:[s[0],s[1],s[2]]:null}function o(r){return r.querySelector("ytd-video-owner-renderer")?.querySelector(".yt-formatted-string")?.textContent||null}function a(r){return r.title.split("- YouTube")[0].trim()}return{getVideoId:t,getTime:n,getVideoName:a,getChannel:o}},j=({logger:e})=>{function t(r){let i=r.pathname.split("/");return i[i.length-1]}function n(r){let i=r.querySelector(".vod-seekbar-time-labels [data-a-target='player-seekbar-current-time']");return!i||!i.textContent?null:i.textContent.split(":").map(s=>Number(s))}function o(r){let i=r.querySelector("[data-a-target='player-info-title'] > a");if(!i){let s=r.title.split("-");return s.length<2?null:s[0].trim()}return i.textContent}function a(r){let i=r.querySelector(".stream-info-card [data-test-selector='stream-info-card-component__subtitle']");return i?i.textContent:(i=r.querySelector("[data-a-target='stream-title']"),!i||!i.textContent?null:i.textContent.split("\u2022")[0])}return{getVideoId:t,getTime:n,getVideoName:a,getChannel:o}};var N=({constants:e,logger:t,getValue:n,setValue:o,variant:a})=>{let{STORAGE_KEY:r,MAX_AGE_DAYS:i}=e,s=`${r}_${a}`,h={},T=()=>n(s,h),x=m=>T()[m],S=()=>Object.entries(T()),c=(m,u)=>{let d=T();if(!d)throw Error("Null storage");d[m]=u,o(s,d)},g=m=>{let u=T(),{[m]:d,...y}=u;return o(s,y),!!d};return{set:c,get:x,getAll:S,delete:g,clear:()=>o(s,{}),purge:()=>{for(let[m,{timestamp:u}]of S()){if(!u){t?.error(`Invalid timestamp for ${m}`);continue}let d=Date.now()-u,y=i*24*60*60*1e3;d>y&&g(m)&&t?.log(`Removed old stored value ${m}`)}},import:m=>{if(!m)throw Error("Null storage");o(s,m)},export:()=>n(s,h)}};function V(e){let t=document.createElement("th");return t.textContent=e,t}var G=({constants:e,storage:t,logger:n,parser:o,urlTool:a,timeouts:r})=>{let{DIALOG_DOM_ID:i}=e,s,h=()=>{try{n?.log("Showing dialog");let c=document.createElement("div");c.id=i,Object.assign(c.style,{width:"100%",height:"100vh",backgroundColor:"rgba(0, 0, 0, 0.5)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e4,display:"flex",justifyContent:"center"}),c.addEventListener("click",()=>{c.style.display="none"});let g=document.createElement("div");Object.assign(g.style,{height:"100%",width:"75%",display:"flex",flexDirection:"column",justifyContent:"center"}),c.appendChild(g);let p=document.createElement("div");Object.assign(p.style,{width:"100%",maxHeight:"50%",overflowY:"auto",backgroundColor:"aliceblue",tableLayout:"fixed",color:"black",padding:"5px",borderRadius:"5px",fontSize:"1.1em"}),g.appendChild(p);let v=document.createElement("table");v.addEventListener("click",u=>{u.stopPropagation()}),Object.assign(v.style,{width:"100%",height:"100%",tableLayout:"fixed"});let f=document.createElement("thead");f.style.borderBottom="1px solid";let E=document.createElement("tbody");v.appendChild(f),v.appendChild(E),f.appendChild(V("Streamer")),f.appendChild(V("Name")),f.appendChild(V("Timestamp")),f.appendChild(V("Stored")),f.appendChild(V("URL")),f.appendChild(V("Actions"));let m=t.getAll();m.sort((u,d)=>d[1].timestamp-u[1].timestamp);for(let[u,{humanTime:d,value:y,videoName:C,channelName:b,url:I}]of m){if(u==="LAST_STORED")continue;let w=document.createElement("tr"),l=document.createElement("td");l.textContent=b||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=b||"-",w.appendChild(l),l=document.createElement("td"),l.textContent=C||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=C||"-",w.appendChild(l),l=document.createElement("td"),l.style.textAlign="center",l.textContent=y.join(":"),w.appendChild(l),l=document.createElement("td"),l.textContent=d||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=d||"-",w.appendChild(l),l=document.createElement("td");let D=document.createElement("a");D.href=I||"-",D.textContent=I||"-",Object.assign(l.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),l.title=I||"-",l.appendChild(D),w.appendChild(l),l=document.createElement("td"),l.style.textAlign="right";let A=document.createElement("button");A.addEventListener("click",()=>{t.delete(u),w.style.display="none",n?.log(`Removed stored valued ${u}`)}),A.textContent="DELETE",l.appendChild(A),w.appendChild(l),E.appendChild(w)}p.appendChild(v),document.body.appendChild(c)}catch(c){n?.error("Error while creating dialog",c)}},T=()=>{x();let c=document.createElement("div");c.id=i,c.style.cssText="background: black; color: white; z-index: 9999; position: absolute; top: 0; left: 0;";let g=document.createElement("dl");function p(d,y){let C=document.createElement("dt"),b=document.createElement("dd");return C.textContent=d,b.textContent=y,b.style.marginLeft="2em",b.style.fontWeight="bolder",[C,b]}let{value:v}=t.get("LAST_STORED")||{},f=o.getVideoId(location),E=o.getTime(document),m={VIDEO_ID:f,STREAMER:o.getChannel(document),TIME:E,STREAM_NAME:o.getVideoName(document),URL:E&&f?a.getTimedUrl(f,E):null,LAST_STORED:v};Object.entries(m).map(([d,y])=>p(d,y)).flat().forEach(d=>g.appendChild(d)),c.appendChild(g),document.body.appendChild(c),n?.log("Showing debug dialog"),s=r.set(T,1e3)};function x(){let c=document.getElementById(i);return c&&c.parentElement?(c.parentElement.removeChild(c),!0):!1}function S(){r.remove(s)}return{removeDialogIfPresent:x,createDialog:h,createDebug:T,clearDebugTimeout:S}},U=({logger:e,storage:t,ui:n})=>{let o=[];return o.push({title:"Dialog",fnAction:()=>{n.clearDebugTimeout(),n.removeDialogIfPresent(),n.createDialog()}}),o.push({title:"Debug",fnAction:()=>{if(n.clearDebugTimeout(),n.removeDialogIfPresent()){e?.log("Closing debug dialog");return}n.createDebug()}}),o.push({title:"Dump stored values",fnAction:()=>{let a=t.getAll();a.sort((r,i)=>i[1].timestamp-r[1].timestamp),e?.log(`
${JSON.stringify(a,null,2)}`)}}),o.push({title:"Nuke DB",fnAction:()=>{t.clear(),e?.log("Removed all entries")}}),o.push({title:"Export DB",fnAction:()=>{let a=t.export();e?.log({export:a})}}),o.push({title:"Import DB",fnAction:()=>{let a=window.prompt("Add db dump");if(!a)return;let r=JSON.parse(a);t.import(r),e?.log("Imported DB")}}),o},P=({logger:e,registerMenu:t,actions:n})=>{n.forEach(o=>{t(o.title,o.fnAction)}),e?.log("Registered UI")};var Y=({logger:e,parser:t,urlTool:n,storage:o,document:a,cache:r,constants:i,timeouts:s})=>{let{INTERVAL_UPDATE_TIME:h}=i,T=1;function x({fnGetTime:g,fnGetStreamName:p,fnGetStreamerName:v,fnSetStored:f,fnGetTimedVodUrl:E,options:m,id:u}){try{e?.log(`Running ${T++}`);let d=p(),y=v();if(!d||!y)return e?.warn("Could not fetch VOD information");let C=g();if(!C)return e?.warn("Could not fetch time information");let[b,I,w]=C;if(m.skipStartOfVideo&&b===0&&I<1)return e?.log("Not storing anything yet");let l=Date.now(),D=E(u,[b,I,w]);f(u,{timestamp:l,humanTime:new Date(l).toISOString(),value:C,videoName:d,channelName:y,url:D});let A=C.join(":");e?.log(`Saved ${A} for ${u}`),i.DEBUG&&e?.log({streamName:d,streamerName:y,time:C,hours:b,minutes:I,seconds:w,timestamp:l,vodUrl:D,storedTimeStr:A}),o.set("LAST_STORED",{timestamp:Date.now(),value:A})}catch(d){e?.error("Error running interval",d)}}let S=({skipStartOfVideo:g=!1}={})=>{let p=t.getVideoId(location);if(!p)return e?.error("Could not get video ID");let v=()=>t.getTime(a),f=r(()=>{let u=t.getVideoName(a);return e?.log(`Got current stream name: '${u}'`),u}),E=R(()=>{let u=t.getChannel(a);return e?.log(`Got current streamer: '${u}'`),u});return x.bind(null,{fnGetStreamName:f,fnGetStreamerName:E,fnSetStored:o.set,fnGetTime:v,fnGetTimedVodUrl:n.getTimedUrl,id:p,options:{skipStartOfVideo:g}})};function c(){e?.log("Starting update interval");let g=S({skipStartOfVideo:!0}),p=s.setInterval(g,h);return e?.log(`Starting interval ${p}`),{cancel:()=>{e?.log(`Cancelling interval ${p}`),s.remove(p)}}}return{start:c,getRunInterval:S}},q=()=>{let e,t=L(),n=O({constants:t}),o={constants:t,logger:n},a=R,r=window.document,i=j(o),s=$(),h=N({...o,getValue:GM_getValue,setValue:GM_setValue,variant:"twitch"}),T=M(o),x=Y({...o,cache:a,document:r,parser:i,storage:h,urlTool:s,timeouts:T}),S=G({constants:t,parser:i,storage:h,timeouts:T,urlTool:s,logger:n});n?.log("Initializing");function c(){n?.log("Matching URL");let p=location.pathname;p.startsWith("/videos")?e||(n?.log(`Current pathname '${p}' matches Twitch video portal, starting tracking`),e=x.start()):e&&(e.cancel(),e=null)}let g=[...U({logger:n,storage:h,ui:S})].sort(_("title"));return{init(){h.purge(),c(),T.setInterval(c,t.INTERVAL_MATCH_URL),P({constants:t,logger:n,registerMenu:GM_registerMenuCommand,actions:g})}}},z=()=>{let e=L(),t=O({constants:e}),n={constants:e,logger:t},o=R,a=window.document,r=B(n),i=k(),s=N({...n,getValue:GM_getValue,setValue:GM_setValue,variant:"youtube"}),h=M(n),T=Y({...n,cache:o,document:a,parser:r,storage:s,urlTool:i,timeouts:h}),x=G({constants:e,parser:r,storage:s,timeouts:h,urlTool:i,logger:t});t?.log("Initializing");let S=null,c=[...U({logger:t,storage:s,ui:x}),{title:"Start interval",fnAction:()=>{t.log("Starting interval manually"),S?.cancel(),S=T.start()}},{title:"Stop interval",fnAction:()=>{t.log("Stopping interval manually"),S?.cancel()}},{title:"Store timestamp",fnAction:()=>{t.log("Running interval manually"),T.getRunInterval({skipStartOfVideo:!1})?.()}}].sort(_("title"));return{init(){s.purge(),P({constants:e,logger:t,registerMenu:GM_registerMenuCommand,actions:c})}}};function K(){let e=location.host;if(e.includes("twitch"))q().init();else if(e.includes("youtube"))z().init();else throw Error(`${e} didn't match any known portal`)}window.addEventListener("load",()=>{K()});})();
