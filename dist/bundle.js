
// ==UserScript==
// @name        Video Saver
// @namespace   samlinz
// @match       https://www.twitch.tv/*
// @match       https://www.youtube.com/*
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_registerMenuCommand
// @icon https://static.twitchcdn.net/assets/favicon-32-d6025c14e900565d6177.png
// @version     121
// @author      samlinz
// @description 9/21/2020, 1:20:46 PM
// ==/UserScript==
// Built: 2023-08-10T09:00:39.943Z

(()=>{var U=n=>(e,t)=>{let o=e[n],a=t[n];return o===a?0:o>a?1:-1};var _=()=>{let n=1,e=10*1e3,t=10*1e3,o=30,a=!0,s="STREAM_SAVER: ",r=`stored_values_ver_${n}`;return{MAJOR_VER:n,INTERVAL_MATCH_URL:t,DIALOG_DOM_ID:"stream-saver-dialog",STORAGE_KEY:r,INTERVAL_UPDATE_TIME:e,LOGGING:a,LOG_PREFIX:s,MAX_AGE_DAYS:o,DEBUG:!1}};var V=({logger:n})=>e=>{let t=1*60*1e3,o,a;function s(){if(Date.now()<a+t)return o;let r=e();return r!=null&&r!==""?(a=Date.now(),o=r,o):(n?.warn("Will not cache nil value"),o)}return s},L=({constants:n})=>{let{LOGGING:e,LOG_PREFIX:t}=n;function o(...r){!e||console.error(t,...r)}function a(...r){!e||console.log(t,...r)}function s(...r){!e||console.warn(t,...r)}return{error:o,log:a,warn:s}},M=({constants:n})=>({set:(a,s)=>window.setTimeout(a,s),setInterval:(a,s)=>window.setInterval(a,s),remove:a=>clearTimeout(a)});var $=n=>{let e=(t,o)=>n.indexOf(t)===o;return n.filter(e)};var N=({logger:n,parser:e,urlTool:t,storage:o,document:a,cache:s,constants:r,timeouts:i})=>{let{INTERVAL_UPDATE_TIME:p}=r,d=1;function y({fnGetTime:h,fnGetStreamName:g,fnGetStreamerName:T,fnSetStored:S,fnGetTimedVodUrl:E,options:f,id:u}){try{n?.log(`Running ${d++}`);let m=g()||`Unknown ${u}`,v=T()||"UKNOWN";if(!m||!v)return n?.error("Could not fetch VOD information",{streamName:m,streamerName:v});let w=h();if(!w)return n?.warn("Could not fetch time information");n?.log("Got time",w);let[b,x,A]=w;if(f.skipStartOfVideo&&b===0&&x<1)return n?.log("Not storing anything yet");let c=Date.now(),I=E(u,[b,x,A]);S(u,{timestamp:c,humanTime:new Date(c).toISOString(),value:w,videoName:m,channelName:v,url:I});let D=w.join(":");n?.log(`Saved ${D} for ${u}; ${I}`),r.DEBUG&&n?.log({streamName:m,streamerName:v,time:w,hours:b,minutes:x,seconds:A,timestamp:c,vodUrl:I,storedTimeStr:D}),o.set("LAST_STORED",{timestamp:Date.now(),value:D})}catch(m){n?.error("Error running interval",m)}}let C=({skipStartOfVideo:h=!1}={})=>{let g=e.getVideoId(location);if(!g)return n?.error("Could not get video ID");n?.log(`Got video ID: '${g}'`);let T=()=>e.getTime(a),S=s(()=>{let u=e.getVideoName(a);return n?.log(`Got current stream name: '${u}'`),u}),E=s(()=>{let u=e.getChannel(a);return n?.log(`Got current streamer: '${u}'`),u});return y.bind(null,{fnGetStreamName:S,fnGetStreamerName:E,fnSetStored:o.set,fnGetTime:T,fnGetTimedVodUrl:t.getTimedUrl,id:g,options:{skipStartOfVideo:h}})};function l(){n?.log("Starting update interval");let h=C({skipStartOfVideo:!0}),g=i.setInterval(h,p);return n?.log(`Starting interval ${g}`),{cancel:()=>{n?.log(`Cancelling interval ${g}`),i.remove(g)}}}return{start:l,getRunInterval:C}};var O=({constants:n,logger:e,getValue:t,setValue:o,variant:a})=>{let{STORAGE_KEY:s,MAX_AGE_DAYS:r}=n,i=`${s}_${a}`,p={},d=()=>t(i,p),y=f=>d()[f],C=()=>Object.entries(d()),l=(f,u)=>{let m=d();if(!m)throw Error("Null storage");m[f]=u,o(i,m)},h=f=>{let u=d(),{[f]:m,...v}=u;return o(i,v),!!m};return{set:l,get:y,getAll:C,delete:h,clear:()=>o(i,{}),purge:()=>{for(let[f,{timestamp:u}]of C()){if(!u){e?.error(`Invalid timestamp for ${f}`);continue}let m=Date.now()-u,v=r*24*60*60*1e3;m>v&&h(f)&&e?.log(`Removed old stored value ${f}`)}},import:f=>{if(!f)throw Error("Null storage");o(i,f)},export:()=>t(i,p)}};function R(n){let e=document.createElement("th");return e.textContent=n,e}var G=({constants:n,storage:e,logger:t,parser:o,urlTool:a,timeouts:s})=>{let{DIALOG_DOM_ID:r}=n,i,p=()=>{try{t?.log("Showing dialog");let l=document.createElement("div");l.id=r,Object.assign(l.style,{width:"100%",height:"100vh",backgroundColor:"rgba(0, 0, 0, 0.5)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e4,display:"flex",justifyContent:"center"}),l.addEventListener("click",()=>{l.style.display="none"});let h=document.createElement("div");Object.assign(h.style,{height:"100%",width:"75%",display:"flex",flexDirection:"column",justifyContent:"center"}),l.appendChild(h);let g=document.createElement("div");Object.assign(g.style,{width:"100%",maxHeight:"50%",overflowY:"auto",backgroundColor:"aliceblue",tableLayout:"fixed",color:"black",padding:"5px",borderRadius:"5px",fontSize:"1.1em"}),h.appendChild(g);let T=document.createElement("table");T.addEventListener("click",u=>{u.stopPropagation()}),Object.assign(T.style,{width:"100%",height:"100%",tableLayout:"fixed"});let S=document.createElement("thead");S.style.borderBottom="1px solid";let E=document.createElement("tbody");T.appendChild(S),T.appendChild(E),S.appendChild(R("Streamer")),S.appendChild(R("Name")),S.appendChild(R("Timestamp")),S.appendChild(R("Stored")),S.appendChild(R("URL")),S.appendChild(R("Actions"));let f=e.getAll();f.sort((u,m)=>m[1].timestamp-u[1].timestamp);for(let[u,{humanTime:m,value:v,videoName:w,channelName:b,url:x}]of f){if(u==="LAST_STORED")continue;let A=document.createElement("tr"),c=document.createElement("td");c.textContent=b||"-",Object.assign(c.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),c.title=b||"-",A.appendChild(c),c=document.createElement("td"),c.textContent=w||"-",Object.assign(c.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),c.title=w||"-",A.appendChild(c),c=document.createElement("td"),c.style.textAlign="center",c.textContent=v.join(":"),A.appendChild(c),c=document.createElement("td"),c.textContent=m||"-",Object.assign(c.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),c.title=m||"-",A.appendChild(c),c=document.createElement("td");let I=document.createElement("a");I.href=x||"-",I.textContent=x||"-",Object.assign(c.style,{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),c.title=x||"-",c.appendChild(I),A.appendChild(c),c=document.createElement("td"),c.style.textAlign="right";let D=document.createElement("button");D.addEventListener("click",()=>{e.delete(u),A.style.display="none",t?.log(`Removed stored valued ${u}`)}),D.textContent="DELETE",c.appendChild(D),A.appendChild(c),E.appendChild(A)}g.appendChild(T),document.body.appendChild(l)}catch(l){t?.error("Error while creating dialog",l)}},d=()=>{y();let l=document.createElement("div");l.id=r,l.style.cssText="background: black; color: white; z-index: 9999; position: absolute; top: 0; left: 0;";let h=document.createElement("dl");function g(m,v){let w=document.createElement("dt"),b=document.createElement("dd");return w.textContent=m,b.textContent=v,b.style.marginLeft="2em",b.style.fontWeight="bolder",[w,b]}let{value:T}=e.get("LAST_STORED")||{},S=o.getVideoId(location),E=o.getTime(document),f={VIDEO_ID:S,STREAMER:o.getChannel(document),TIME:E,STREAM_NAME:o.getVideoName(document),URL:E&&S?a.getTimedUrl(S,E):null,LAST_STORED:T};Object.entries(f).map(([m,v])=>g(m,v)).flat().forEach(m=>h.appendChild(m)),l.appendChild(h),document.body.appendChild(l),t?.log("Showing debug dialog"),i=s.set(d,1e3)};function y(){let l=document.getElementById(r);return l&&l.parentElement?(l.parentElement.removeChild(l),!0):!1}function C(){s.remove(i)}return{removeDialogIfPresent:y,createDialog:p,createDebug:d,clearDebugTimeout:C}},P=({logger:n,storage:e,ui:t})=>{let o=[];return o.push({title:"Dialog",fnAction:()=>{t.clearDebugTimeout(),t.removeDialogIfPresent(),t.createDialog()}}),o.push({title:"Debug",fnAction:()=>{if(t.clearDebugTimeout(),t.removeDialogIfPresent()){n?.log("Closing debug dialog");return}t.createDebug()}}),o.push({title:"Dump stored values",fnAction:()=>{let a=e.getAll();a.sort((s,r)=>r[1].timestamp-s[1].timestamp),n?.log(`
${JSON.stringify(a,null,2)}`)}}),o.push({title:"Nuke DB",fnAction:()=>{e.clear(),n?.log("Removed all entries")}}),o.push({title:"Export DB",fnAction:()=>{let a=e.export();n?.log({export:a})}}),o.push({title:"Import DB",fnAction:()=>{let a=window.prompt("Add db dump");if(!a)return;let s=JSON.parse(a);e.import(s),n?.log("Imported DB")}}),o},k=({logger:n,registerMenu:e,actions:t})=>{t.forEach(o=>{e(o.title,o.fnAction)}),n?.log("Registered UI")};var K=()=>({getTimedUrl:(e,t)=>{let[o,a,s]=t;return`https://www.twitch.tv/videos/${e}?t=${o}h${a}m${s}s`}}),F=({logger:n})=>{function e(r){let i=r.pathname.split("/");return i[i.length-1]}let t=()=>{let r=document.querySelector("script[type='application/ld+json']")?.textContent;return r&&JSON.parse(r)[0]||null};function o(r){let i=r.querySelector(".vod-seekbar-time-labels [data-a-target='player-seekbar-current-time']");return!i||!i.textContent?null:i.textContent.split(":").map(p=>Number(p))}function a(r){let i=Array.from(r.querySelectorAll("[data-room]")).map(d=>d.getAttribute("data-room"));return $(i).join(",")}function s(r){return r.title.split("-")[0].trim()}return{getVideoId:e,getTime:o,getVideoName:s,getChannel:a}},j=()=>{let n,e=_(),t=L({constants:e}),o={constants:e,logger:t},a=V(o),s=window.document,r=F(o),i=K(),p=O({...o,getValue:GM_getValue,setValue:GM_setValue,variant:"twitch"}),d=M(o),y=N({...o,cache:a,document:s,parser:r,storage:p,urlTool:i,timeouts:d}),C=G({constants:e,parser:r,storage:p,timeouts:d,urlTool:i,logger:t});t?.log("Initializing Twitch"),t?.log("Constants",{...e});function l(){t?.log("Matching URL");let g=location.pathname;g.startsWith("/videos")?n||(t?.log(`Current pathname '${g}' matches Twitch video portal, starting tracking`),n=y.start()):n&&(n.cancel(),n=null)}let h=[...P({logger:t,storage:p,ui:C})].sort(U("title"));return{init(){p.purge(),l(),d.setInterval(l,e.INTERVAL_MATCH_URL),k({constants:e,logger:t,registerMenu:GM_registerMenuCommand,actions:h})}}};var B="__ss_check",H=`${B}=1`,J=()=>({getTimedUrl:(e,t)=>{let[o,a,s]=t,r=(o||0)*3600+(a||0)*60+s,i=new URL("https://www.youtube.com/watch");return i.searchParams.set("v",e),i.searchParams.set("t",r.toString()),i.searchParams.set(B,1),i.toString()}}),W=({logger:n})=>{function e(s){return new URL(s.href).searchParams.get("v")}function t(s){let i=s.querySelector(".ytp-time-current")?.textContent?.split(":").map(p=>Number(p))||null;return i?i?.length<3?[0,i[0],i[1]]:[i[0],i[1],i[2]]:null}function o(s){return[()=>{let d=s.querySelectorAll("[type='application/ld+json']")[0]?.textContent;return d&&JSON.parse(d).author||null},()=>s.querySelector("[itemprop=author]")?.querySelector("[itemprop=name]")?.getAttribute("content")||null,()=>s.querySelector("ytd-video-owner-renderer")?.querySelector(".yt-formatted-string")?.textContent||null].map(d=>{try{return d()}catch{return null}}).find(Boolean)||null}function a(s){return s.title.split("- YouTube")[0].trim()}return{getVideoId:e,getTime:t,getVideoName:a,getChannel:o}},Y=({initialUrl:n})=>{let e=_(),t=L({constants:e}),o={constants:e,logger:t},a=V(o),s=window.document,r=W(o),i=J(),p=O({...o,getValue:GM_getValue,setValue:GM_setValue,variant:"youtube"}),d=M(o),y=N({...o,cache:a,document:s,parser:r,storage:p,urlTool:i,timeouts:d}),C=G({constants:e,parser:r,storage:p,timeouts:d,urlTool:i,logger:t});t?.log("Initializing Youtube"),t?.log("Constants",{...e});let l=null,h=[...P({logger:t,storage:p,ui:C}),{title:"Start interval",fnAction:()=>{t.log("Starting interval manually"),l?.cancel(),l=y.start()}},{title:"Stop interval",fnAction:()=>{t.log("Stopping interval manually"),l?.cancel()}},{title:"Store timestamp",fnAction:()=>{t.log("Running interval manually"),y.getRunInterval({skipStartOfVideo:!1})?.()}}].sort(U("title"));function g(){t?.log("Matching URL",n),new URL(n).search.includes(H)&&(t.log("Current video was navigated from stream saver; starting interval automatically"),l?.cancel(),l=y.start())}return{init(){p.purge(),k({constants:e,logger:t,registerMenu:GM_registerMenuCommand,actions:h}),setTimeout(g,1e3)}}};function q({initialUrl:n}){let e=location.host,t={initialUrl:n};if(e.includes("twitch"))j(t).init();else if(e.includes("youtube"))Y(t).init();else throw Error(`${e} didn't match any known portal`)}var z=window.location.href;window.addEventListener("load",()=>{q({initialUrl:z})});})();
